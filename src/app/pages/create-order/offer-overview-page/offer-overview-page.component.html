<div class="offer-page-container">
  <div
    class="mb-3"
    [ngClass]="{ 'd-none': !isLoaded && !clientStore.isBusy() }"
  >
    <div class="full-width mb-3">
      <mat-accordion class="w-100" multi>
        <mat-expansion-panel [expanded]="false">
          <mat-expansion-panel-header class="px-3">
            <div class="d-flex justify-content-center align-items-center">
              {{ "OVERVIEW_PAGE.PRICES.TITLE" | translate }} -
              {{ clientStore.isClientPJ() ? "PJ" : "PF" }}
            </div>
          </mat-expansion-panel-header>
          <div class="w-100">
            <div class="d-flex flex-column">
              @for (
                price of usedPriceCategories;
                let last = $last;
                track $index
              ) {
                <div class="price-row py-1 px-3">
                  <div class="price-info">
                    <div class="price-label">
                      @if (price.unit === 2 || price.productId) {
                        {{ getProductName(price.productId!) }}
                      } @else {
                        {{
                          "OFFER_PAGE.CREATE_OFFER.UNIT_FILTER.FILTER_OPTIONS." +
                            price.unit | translate
                        }}
                      }
                      -
                      {{
                        "OFFER_PAGE.CREATE_OFFER.PRICE_CATEGORY." +
                          price.category | translate
                      }}
                      -
                      {{
                        "OFFER_PAGE.CREATE_OFFER.SIZE_FILTER.FILTER_OPTIONS." +
                          price.size | translate
                      }}
                    </div>
                    <div class="price-details">
                      <div class="base-prices">
                        <span class="label"
                          >{{ "OVERVIEW_PAGE.PRICES.BASE" | translate }}:</span
                        >
                        @if (price.price.length) {
                          @for (
                            pr of price.price;
                            let last = $last;
                            track $index
                          ) {
                            <span class="price-value">
                              {{ pr | number: "1.2-2" }}
                              @if (!last) {
                                ,
                              }
                            </span>
                          }
                          <span class="currency">RON</span>
                        }
                      </div>
                      @if (price.discount !== 0) {
                        <div
                          class="discount-info"
                          [class.negative]="price.discount < 0"
                          [class.positive]="price.discount > 0"
                        >
                          <span class="label"
                            >{{
                              "OVERVIEW_PAGE.PRICES.ADJUSTMENT" | translate
                            }}:</span
                          >
                          <span class="discount-value">
                            {{ price.discount > 0 ? "+" : ""
                            }}{{ price.discount | number: "1.2-2" }} RON
                          </span>
                        </div>
                      }
                      <div class="final-prices">
                        <span class="label"
                          >{{ "OVERVIEW_PAGE.PRICES.FINAL" | translate }}:</span
                        >
                        @for (
                          finalPrice of getPricesWithDiscount(price);
                          let last = $last;
                          track $index
                        ) {
                          <span class="price-value final">
                            {{ finalPrice | number: "1.2-2" }}
                            @if (!last) {
                              ,
                            }
                          </span>
                        }
                        <span class="currency">RON</span>
                      </div>
                    </div>
                  </div>

                  <div class="price-input-wrapper">
                    <mat-form-field appearance="outline" class="price-field">
                      <mat-label>{{
                        "OVERVIEW_PAGE.PRICES.SET_PRICE" | translate
                      }}</mat-label>
                      <input
                        matInput
                        type="number"
                        [ngModel]="getFinalPrice(price)"
                        (ngModelChange)="
                          setFinalPrice(
                            price.category,
                            price.size,
                            price.unit,
                            $event
                          )
                        "
                        [step]="10"
                        placeholder="{{
                          getBasePrice(price) | number: '1.2-2'
                        }}"
                      />
                      <span matTextSuffix>RON</span>
                    </mat-form-field>
                  </div>
                </div>
                @if (!last) {
                  <mat-divider />
                }
              }
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <app-client-details class="full-width mb-3"></app-client-details>

    <app-selected-product-list
      [isInOverview]="true"
      [discounts]="usedPriceCategories"
      (isLoaded)="loaded()"
      (pricesOutput)="getPriceList($event)"
      class="full-width"
    ></app-selected-product-list>
    <div class="mt-2 total-quantity-card">
      <div class="total-quantity">
        <div>{{ "COMING_WARES.TOTAL_QUANTITY" | translate }}:</div>
        <div>{{ getTotalQuantity() | number: "1.0-2" }} mÂ³</div>
      </div>
    </div>
  </div>

  <div
    class="w-100 d-flex flex-column justify-content-center"
    [ngClass]="{ 'd-none': !isLoaded }"
  >
    <div class="d-flex w-100 align-items-center justify-content-evenly mb-3">
      <mat-form-field appearance="outline" class="voucher-input">
        <mat-label>{{ "WORDS.VOUCHER" | translate }}</mat-label>
        <input matInput [(ngModel)]="voucher" />
      </mat-form-field>

      <div class="fs-5">
        {{ "WORDS.TOTAL" | translate }}: {{ totalPrice | currency: "RON" }}
      </div>
    </div>

    <button mat-raised-button color="primary" (click)="confirmOffer()">
      {{ "OVERVIEW_PAGE.BUTTONS.CONFIRM" | translate }}
    </button>
  </div>
  @if (!isLoaded) {
    <mat-spinner />
  }
</div>

<ng-template #confirmOfferDialog>
  <h2 mat-dialog-title>{{ "OVERVIEW_PAGE.BUTTONS.CONFIRM" | translate }}</h2>
  <mat-dialog-content class="text-center">
    <mat-form-field class="w-100" appearance="outline">
      <mat-label>{{ "OVERVIEW_PAGE.POPUP.COMMENT" | translate }}</mat-label>
      <textarea
        [rows]="clientStore.client().tva ? 4 : 3"
        matInput
        [(ngModel)]="comment"
      ></textarea>
    </mat-form-field>

    <mat-form-field class="w-100" appearance="outline">
      <mat-label>{{
        "OVERVIEW_PAGE.POPUP.EXPECTED_DELIVERY" | translate
      }}</mat-label>
      <input
        matInput
        [(ngModel)]="expectedDeliveryDate"
        [min]="currentDate"
        [matDatepicker]="picker"
      />
      <mat-datepicker-toggle
        matIconSuffix
        [for]="picker"
      ></mat-datepicker-toggle>
      <mat-datepicker touchUi #picker></mat-datepicker>
    </mat-form-field>

    <div class="d-flex flex-column justify-content-start text-start">
      <mat-checkbox
        [(ngModel)]="untilDeliveryDate"
        [matTooltip]="
          'OVERVIEW_PAGE.POPUP.DELIVERY_CHECKBOX_TOOLTIP' | translate
        "
        >{{ "OVERVIEW_PAGE.POPUP.DELIVERY_CHECKBOX" | translate }}</mat-checkbox
      >

      <mat-checkbox class="mt-2" [(ngModel)]="forFirstHour">{{
        "OVERVIEW_PAGE.POPUP.FIRST_HOUR_CHECKBOX" | translate
      }}</mat-checkbox>

      <mat-checkbox class="mt-2" [(ngModel)]="justOffer">{{
        "OVERVIEW_PAGE.POPUP.JUST_OFFER_CHECKBOX" | translate
      }}</mat-checkbox>

      <mat-checkbox class="mt-2" [(ngModel)]="transferPayment">{{
        "OVERVIEW_PAGE.POPUP.TRANSFER_PAYMENT" | translate
      }}</mat-checkbox>
    </div>

    <div class="delivery-input-field">
      <mat-form-field
        @enterAndLeaveAnimation
        class="mt-2 w-100"
        appearance="outline"
        [floatLabel]="'always'"
      >
        <mat-label>
          {{ "OVERVIEW_PAGE.POPUP.DELIVERY_ADDRESS" | translate }}
        </mat-label>
        <input
          matInput
          [(ngModel)]="delivery_address"
          [placeholder]="
            this.clientStore.client().address
              ? this.clientStore.client().address!
              : ''
          "
          type="text"
        />
      </mat-form-field>
    </div>

    <div class="delivery-input-field">
      <mat-form-field
        @enterAndLeaveAnimation
        class="mt-2 w-100"
        appearance="outline"
      >
        <mat-label>
          {{ "OVERVIEW_PAGE.POPUP.DELIVERY_FEE" | translate }}
        </mat-label>
        <input matInput [(ngModel)]="deliveryFee" type="number" />
      </mat-form-field>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions>
    <button mat-button [mat-dialog-close]="false">
      {{ "OVERVIEW_PAGE.POPUP.BACK_BUTTON" | translate }}
    </button>
    <button mat-button [mat-dialog-close]="true" cdkFocusInitial>
      {{ "OVERVIEW_PAGE.POPUP.SAVE_BUTTON" | translate }}
    </button>
  </mat-dialog-actions>
</ng-template>
