<div class="offer-page-container">
  <div
    class="mb-3"
    [ngClass]="{ 'd-none': !isLoaded && !clientStore.isBusy() }"
  >
    <div class="full-width mb-3">
      <mat-accordion class="w-100" multi>
        <mat-expansion-panel [expanded]="false">
          <mat-expansion-panel-header class="px-3">
            <div class="d-flex justify-content-center align-items-center">
              {{ "OVERVIEW_PAGE.PRICES.TITLE" | translate }} -
              {{ clientStore.isClientPJ() ? "PJ" : "PF" }}
            </div>
          </mat-expansion-panel-header>
          <div class="w-100">
            <div class="d-flex flex-column">
              @for (
                price of usedPriceCategories;
                let last = $last;
                track $index
              ) {
                <div
                  class="d-flex justify-content-between align-items-center py-1"
                >
                  <div class="w-100 text-center overflow-auto">
                    {{
                      "OFFER_PAGE.CREATE_OFFER.UNIT_FILTER.FILTER_OPTIONS." +
                        price.unit | translate
                    }}
                    -
                    {{
                      "OFFER_PAGE.CREATE_OFFER.PRICE_CATEGORY." + price.category
                        | translate
                    }}
                    @if (price.price.length) {
                      @if (price.price.length > 2) {
                        <br />
                      }
                      @for (pr of price.price; let last = $last; track $index) {
                        @if (!last) {
                          {{ pr + price.discount }},
                        } @else {
                          {{ pr + price.discount }}
                        }
                      }
                      RON
                    }
                    @if (price.discount) {
                      ({{ price.discount }})
                    }
                  </div>
                  <div class="d-flex text-center">
                    <mat-icon
                      class="border border-1 shadow text-black rounded d-flex justify-content-center align-items-center me-3 p-3 discount-button"
                      (click)="updateDiscount(price.category, price.unit, 5)"
                      >add</mat-icon
                    >
                    <mat-icon
                      class="border border-1 shadow text-black rounded d-flex justify-content-center align-items-center p-3 discount-button"
                      (click)="updateDiscount(price.category, price.unit, -5)"
                      >horizontal_rule</mat-icon
                    >
                  </div>
                </div>
                @if (!last) {
                  <mat-divider />
                }
              }
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <app-client-details class="full-width mb-3"></app-client-details>

    <app-selected-product-list
      [isInOverview]="true"
      [discount]="usedPriceCategories"
      (isLoaded)="loaded()"
      (pricesOutput)="getPriceList($event)"
      class="full-width"
    ></app-selected-product-list>
    <div class="mt-2 total-quantity-card">
      <div class="total-quantity">
        <div>{{ "COMING_WARES.TOTAL_QUANTITY" | translate }}:</div>
        <div>{{ getTotalQuantity() | number: "1.0-2" }} mÂ³</div>
      </div>
    </div>
  </div>

  <div
    class="w-100 d-flex flex-column justify-content-center"
    [ngClass]="{ 'd-none': !isLoaded }"
  >
    <div class="d-flex w-100 align-items-center justify-content-evenly mb-3">
      <mat-form-field appearance="outline" class="voucher-input">
        <mat-label>{{ "WORDS.VOUCHER" | translate }}</mat-label>
        <input matInput [(ngModel)]="voucher" />
      </mat-form-field>

      <div class="fs-5">
        {{ "WORDS.TOTAL" | translate }}: {{ totalPrice | currency: "RON" }}
      </div>
    </div>

    <button mat-raised-button color="primary" (click)="confirmOffer()">
      {{ "OVERVIEW_PAGE.BUTTONS.CONFIRM" | translate }}
    </button>
  </div>
  @if (!isLoaded) {
    <mat-spinner />
  }
</div>

<ng-template #confirmOfferDialog>
  <h2 mat-dialog-title>{{ "OVERVIEW_PAGE.BUTTONS.CONFIRM" | translate }}</h2>
  <mat-dialog-content class="text-center">
    <mat-form-field class="w-100" appearance="outline">
      <mat-label>{{ "OVERVIEW_PAGE.POPUP.COMMENT" | translate }}</mat-label>
      <textarea
        [rows]="clientStore.isClientPJ() ? 4 : 3"
        matInput
        [(ngModel)]="comment"
      ></textarea>
    </mat-form-field>

    <mat-form-field class="w-100" appearance="outline">
      <mat-label>{{
        "OVERVIEW_PAGE.POPUP.EXPECTED_DELIVERY" | translate
      }}</mat-label>
      <input
        matInput
        [(ngModel)]="expectedDeliveryDate"
        [min]="currentDate"
        [matDatepicker]="picker"
      />
      <mat-datepicker-toggle
        matIconSuffix
        [for]="picker"
      ></mat-datepicker-toggle>
      <mat-datepicker touchUi #picker></mat-datepicker>
    </mat-form-field>

    <div class="d-flex flex-column justify-content-start text-start">
      <mat-checkbox
        [(ngModel)]="untilDeliveryDate"
        [matTooltip]="
          'OVERVIEW_PAGE.POPUP.DELIVERY_CHECKBOX_TOOLTIP' | translate
        "
        >{{ "OVERVIEW_PAGE.POPUP.DELIVERY_CHECKBOX" | translate }}</mat-checkbox
      >

      <mat-checkbox class="mt-2" [(ngModel)]="forFirstHour">{{
        "OVERVIEW_PAGE.POPUP.FIRST_HOUR_CHECKBOX" | translate
      }}</mat-checkbox>

      <mat-checkbox class="mt-2" [(ngModel)]="justOffer">{{
        "OVERVIEW_PAGE.POPUP.JUST_OFFER_CHECKBOX" | translate
      }}</mat-checkbox>
    </div>

    <div class="delivery-input-field">
      <mat-form-field
        @enterAndLeaveAnimation
        class="mt-2 w-100"
        appearance="outline"
        [floatLabel]="'always'"
      >
        <mat-label>
          {{ "OVERVIEW_PAGE.POPUP.DELIVERY_ADDRESS" | translate }}
        </mat-label>
        <input
          matInput
          [(ngModel)]="delivery_address"
          [placeholder]="
            this.clientStore.client().address
              ? this.clientStore.client().address!
              : ''
          "
          type="text"
        />
      </mat-form-field>
    </div>

    <div class="delivery-input-field">
      <mat-form-field
        @enterAndLeaveAnimation
        class="mt-2 w-100"
        appearance="outline"
      >
        <mat-label>
          {{ "OVERVIEW_PAGE.POPUP.DELIVERY_FEE" | translate }}
        </mat-label>
        <input matInput [(ngModel)]="deliveryFee" type="number" />
      </mat-form-field>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions>
    <button mat-button [mat-dialog-close]="false">
      {{ "OVERVIEW_PAGE.POPUP.BACK_BUTTON" | translate }}
    </button>
    <button mat-button [mat-dialog-close]="true" cdkFocusInitial>
      {{ "OVERVIEW_PAGE.POPUP.SAVE_BUTTON" | translate }}
    </button>
  </mat-dialog-actions>
</ng-template>
