@if (order && !clientStore.isBusy()) {
  <div id="content" class="d-flex flex-column w-100 pb-3">
    @if (!isLoading()) {
      <div class="d-flex align-items-center justify-content-between w-100 px-1">
        {{ client().name }} -
        {{ order.dateOrderPlaced | date: "yyyy.MM.dd" }}
        <div class="d-flex">
          <button
            class="d-flex align-items-center"
            mat-icon-button
            (click)="print()"
            [disabled]="isLoading()"
          >
            <mat-icon>print</mat-icon>
          </button>
          <button
            class="d-flex align-items-center"
            mat-icon-button
            (click)="openEditDialog()"
          >
            <mat-icon>edit_note</mat-icon>
          </button>
          <button
            class="d-flex align-items-center"
            mat-icon-button
            (click)="closeDetailsComponent()"
          >
            <mat-icon>cancel</mat-icon>
          </button>
        </div>
      </div>
      <mat-divider class="my-3"></mat-divider>
      <div class="bg-white text-dark rounded shadow p-3">
        @for (
          item of orderItems;
          let i = $index;
          let last = $last;
          track $index
        ) {
          <div class="position-relative">
            <div
              class="d-flex align-items-center justify-content-between flex-wrap py-2 px-1"
              [ngClass]="{
                'border-1 border-bottom': !last,
              }"
            >
              <span class="text-nowrap">
                {{ item.product.name }} - <b>{{ item.category.name }}</b>
              </span>
              @if (item.packsPieces) {
                <span class="text-nowrap">
                  {{ item.packsPieces }} ({{ item.quantity | number: "1.0-2" }}
                  {{
                    "OFFER_PAGE.CREATE_OFFER.UNIT_FILTER.FILTER_OPTIONS." +
                      item.product.unit_id | translate
                  }})
                </span>
              }
              @if (!item.packsPieces && item.product.unit_id === 3) {
                <span class="text-nowrap">
                  {{ item.quantity }}
                  {{
                    (item.product.width
                      ? "OFFER_PAGE.CREATE_OFFER.UNIT_FILTER.FILTER_OPTIONS.1"
                      : "OFFER_PAGE.CREATE_OFFER.UNIT_FILTER.FILTER_OPTIONS.3"
                    ) | translate
                  }}
                </span>
              }
              @if (!item.packsPieces && item.product.unit_id !== 3) {
                <span class="text-nowrap">
                  {{ item.quantity }}
                  {{
                    "OFFER_PAGE.CREATE_OFFER.UNIT_FILTER.FILTER_OPTIONS." +
                      item.product.unit_id | translate
                  }}
                </span>
              }
              <span class="text-nowrap"
                >{{ item.price | number: "1.0-1" }} RON</span
              >
            </div>
          </div>
        }
      </div>

      <div
        class="d-flex flex-column bg-white text-dark rounded shadow p-3 mt-3"
      >
        <div class="client-detail-item">
          <b class="pe-1"> {{ client().type === 1 ? "CNP " : "CUI " }} </b>
          :
          {{ client().code }}
        </div>
        @for (
          phone of client().client_phones;
          track $index;
          let first = $first
        ) {
          <div
            (click)="callNumber(phone.phone)"
            class="client-detail-item pt-1"
          >
            @if (first) {
              <i class="material-icons">phone_iphone</i>:
            }
            <div [ngClass]="{ 'ms-4': !first }">
              {{ phone.phone }}
              @if (phone.label) {
                - ({{ phone.label }})
              }
            </div>
          </div>
        }
        <div
          (click)="openInMapsApp(order.delivery_address!)"
          class="client-detail-item pt-1"
        >
          <i class="material-icons">delivery_dining</i>
          : {{ order.delivery_address }}
        </div>
        <mat-divider class="mb-1" />
        <div class="client-detail-item">
          {{
            client().type === 1
              ? ("PRINT_POPUP.ADDRESS_PF" | translate)
              : ("PRINT_POPUP.ADDRESS_PJ" | translate)
          }}
          {{ client().address }}
        </div>
        <mat-divider class="mb-1" />
        @if (client().other_details) {
          <div class="client-detail-item">{{ client().other_details }}</div>
          <mat-divider class="mb-2 mt-1" />
        }
        @if (order.comment) {
          <div class="client-detail-item multiline-text">
            {{ order.comment }}
          </div>
        }
      </div>
      @if (!order.dateOrderDelivered && !justOffers) {
        <button
          class="mt-3"
          mat-flat-button
          (click)="confirmDelivered(order.id)"
        >
          {{ "ORDER.DETAILS.DELIVERED_BUTTON" | translate }}
        </button>
      }
      @if (justOffers) {
        <button
          class="mt-3"
          mat-flat-button
          (click)="transformOfferToOrder(order)"
        >
          {{ "ORDER.DETAILS.SIMPLE_TRANSFORM_BUTTON" | translate }}
        </button>

        <button
          class="mt-3"
          mat-raised-button
          (click)="transformExactOfferToOrder(order)"
        >
          {{ "ORDER.DETAILS.TOTAL_TRANSFORM_BUTTON" | translate }}
        </button>
      }
    } @else {
      <div class="d-flex justify-content-center w-100">
        <mat-spinner></mat-spinner>
      </div>
    }
  </div>
}

<ng-template #editOfferDialog>
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="text-center w-80" mat-dialog-title>
      {{ "ORDER.DETAILS.EDIT_DIALOG.TITLE" | translate }}
    </h2>
    <button
      class="d-flex align-items-center justify-content-center me-4"
      mat-icon-button
      [mat-dialog-close]="false"
    >
      <i class="material-icons">cancel</i>
    </button>
  </div>

  <mat-dialog-content class="d-flex flex-column comment-edit-input gap-3">
    <mat-form-field class="w-100" appearance="outline">
      <mat-label>{{ "OVERVIEW_PAGE.POPUP.COMMENT" | translate }}</mat-label>
      <textarea [rows]="3" matInput [(ngModel)]="orderComment"></textarea>
    </mat-form-field>

    <div class="edit-order-popup-list">
      @for (
        item of orderItems;
        let i = $index;
        let last = $last;
        track $index
      ) {
        <div
          class="d-flex align-items-center justify-content-between flex-wrap py-2 w-100"
          [ngClass]="{
            'border-1 border-bottom': !last,
          }"
        >
          <span class="text-nowrap">
            {{ item.product.name }} - <b>{{ item.category.name }}</b>
          </span>

          @if (item.packsPieces) {
            <span class="text-nowrap">
              {{ item.packsPieces }} ({{ item.quantity | number: "1.0-2" }}
              {{
                "OFFER_PAGE.CREATE_OFFER.UNIT_FILTER.FILTER_OPTIONS." +
                  item.product.unit_id | translate
              }})
            </span>
          }
          @if (!item.packsPieces && item.product.unit_id === 3) {
            <span class="text-nowrap">
              {{ item.quantity }}
              {{
                (item.product.width
                  ? "OFFER_PAGE.CREATE_OFFER.UNIT_FILTER.FILTER_OPTIONS.1"
                  : "OFFER_PAGE.CREATE_OFFER.UNIT_FILTER.FILTER_OPTIONS.3"
                ) | translate
              }}
            </span>
          }
          @if (!item.packsPieces && item.product.unit_id !== 3) {
            <span class="text-nowrap">
              {{ item.quantity }}
              {{
                "OFFER_PAGE.CREATE_OFFER.UNIT_FILTER.FILTER_OPTIONS." +
                  item.product.unit_id | translate
              }}
            </span>
          }

          <button mat-icon-button (click)="deleteOrderItem(item)">
            <i class="material-icons">delete</i>
          </button>
        </div>
      }
    </div>

    <div class="add-form-conteiner rounded">
      <form class="w-100">
        <mat-chip-listbox
          class="ms-2"
          [(ngModel)]="selectedCategory"
          [hideSingleSelectionIndicator]="true"
          [ngModelOptions]="{ standalone: true }"
        >
          <mat-chip-option
            [value]="categoryEnum.A"
            [selected]="categoryEnum.A === selectedCategory"
            [disabled]="
              categoryEnum.A === selectedCategory || !enableCategory[0].enable
            "
            >{{
              "OFFER_PAGE.CREATE_OFFER.PRICE_CATEGORY." + categoryEnum.A
                | translate
            }}</mat-chip-option
          >
          <mat-chip-option
            [value]="categoryEnum.AB"
            [selected]="categoryEnum.AB === selectedCategory"
            [disabled]="
              categoryEnum.AB === selectedCategory || !enableCategory[1].enable
            "
            >{{
              "OFFER_PAGE.CREATE_OFFER.PRICE_CATEGORY." + categoryEnum.AB
                | translate
            }}</mat-chip-option
          >
          <mat-chip-option
            [value]="categoryEnum.B"
            [selected]="categoryEnum.B === selectedCategory"
            [disabled]="
              categoryEnum.B === selectedCategory || !enableCategory[2].enable
            "
            >{{
              "OFFER_PAGE.CREATE_OFFER.PRICE_CATEGORY." + categoryEnum.B
                | translate
            }}</mat-chip-option
          >
          <mat-chip-option
            [value]="categoryEnum.T"
            [selected]="categoryEnum.T === selectedCategory"
            [disabled]="
              categoryEnum.T === selectedCategory || !enableCategory[3].enable
            "
            >{{
              "OFFER_PAGE.CREATE_OFFER.PRICE_CATEGORY." + categoryEnum.T
                | translate
            }}</mat-chip-option
          >
        </mat-chip-listbox>

        <mat-form-field class="w-100" appearance="fill">
          <mat-label>
            {{
              "OFFER_PAGE.CREATE_OFFER.PRODUCT_SELECT.SELECT_LABEL" | translate
            }}
          </mat-label>
          <input
            #input
            type="text"
            matInput
            [formControl]="myControl"
            [matAutocomplete]="auto"
            (input)="filter()"
            (focus)="filter()"
          />
          <mat-autocomplete
            #auto="matAutocomplete"
            requireSelection
            (optionSelected)="optionSelected($event.option.value)"
            [displayWith]="displayProductLabel"
          >
            @for (option of filteredOptions; track option) {
              <mat-option [value]="option">{{ option.name }}</mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>
        <div class="d-flex w-100">
          <mat-form-field class="mt-2 w-50" appearance="fill">
            <mat-label>
              {{ "PRINT_POPUP.TABLE.QUANTITY" | translate }}
            </mat-label>
            <input
              matInput
              [(ngModel)]="selectedProductQuantity"
              type="number"
              [ngModelOptions]="{ standalone: true }"
            />
          </mat-form-field>

          <div class="d-flex align-items-center justify-content-end w-50">
            <button mat-icon-button (click)="addOrderItem()">
              <i class="material-icons text-white fs-1">add_circle</i>
            </button>
          </div>
        </div>
      </form>
    </div>
  </mat-dialog-content>
</ng-template>

<ng-template #confirmTransformExactOfferDialog>
  <h2 class="text-center" mat-dialog-title>
    {{ "ORDER.DETAILS.TRANSFORM_POPUP" | translate }}
  </h2>
  <mat-dialog-content>
    <div class="multiline-text">
      {{ "ORDER.DETAILS.TOTAL_TRANSFORM_DESCRIPTION" | translate }}
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button [mat-dialog-close]="false">
      {{ "ORDER.DETAILS.POPUP_CANCEL" | translate }}
    </button>
    <button mat-raised-button color="warn" [mat-dialog-close]="true">
      {{ "ORDER.DETAILS.POPUP_CONFIRM" | translate }}
    </button>
  </mat-dialog-actions>
</ng-template>

<ng-template #confirmTransformOfferDialog>
  <h2 class="text-center" mat-dialog-title>
    {{ "ORDER.DETAILS.TRANSFORM_POPUP" | translate }}
  </h2>
  <mat-dialog-content>
    <div>
      {{ "ORDER.DETAILS.SIMPLE_TRANSFORM_DESCRIPTION" | translate }}
    </div>
    <mat-checkbox class="ms-3 mt-2" [(ngModel)]="deleteOffer">{{
      "ORDER.DETAILS.POPUP_CHECKBOX" | translate
    }}</mat-checkbox>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button [mat-dialog-close]="false">
      {{ "ORDER.DETAILS.POPUP_CANCEL" | translate }}
    </button>
    <button mat-raised-button color="warn" [mat-dialog-close]="true">
      {{ "ORDER.DETAILS.POPUP_CONFIRM" | translate }}
    </button>
  </mat-dialog-actions>
</ng-template>

<ng-template #confirmDeliveredDialog>
  <h2 class="text-center" mat-dialog-title>
    {{ "ORDER.DETAILS.POPUP_TITLE" | translate }}
  </h2>
  <mat-dialog-actions align="end">
    <button mat-button [mat-dialog-close]="false">
      {{ "ORDER.DETAILS.POPUP_CANCEL" | translate }}
    </button>
    <button mat-raised-button color="warn" [mat-dialog-close]="true">
      {{ "ORDER.DETAILS.POPUP_CONFIRM" | translate }}
    </button>
  </mat-dialog-actions>
</ng-template>

@if (isPrinting()) {
  <app-order-pdf
    [order]="order!"
    [justOffer]="justOffers"
    [isPrinting]="isPrinting()"
    [orderItems]="orderItems!"
  />
}
